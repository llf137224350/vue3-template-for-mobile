'use strict';
Object.defineProperty(exports, '__esModule', { value: true });
exports.request = exports.getDataFromServer = exports.isAbsoluteUrl = void 0;
const config_1 = require('./config');
const encrypt_and_decrypt_1 = require('./encrypt_and_decrypt');
const wx_helper_1 = require('./wx_helper');
const util_1 = require('./util');
function isAbsoluteUrl(url) {
  return /(^[a-z][a-z\d\+\-\.]*:)?\/\//i.test(url);
}
exports.isAbsoluteUrl = isAbsoluteUrl;
function _stitchingUrl(url) {
  return isAbsoluteUrl(url) ? url : config_1.Config.HOST.replace(/\/+$/, '') + '/' + url.replace(/^\/+/, '');
}
function _getSignature(params, path, token, timestamp, nonceStr) {
  const keys = Object.keys(params).sort();
  let sign = '';
  for (let _i = 0, keys_1 = keys; _i < keys_1.length; _i++) {
    const key = keys_1[_i];
    const value = params[key];
    if (typeof value === 'object' && value !== null) {
      let v = JSON.stringify(params[key]);
      v = v
        .split('')
        .sort()
        .join('');
      sign += key + '=' + v + '&';
    } else {
      if (value !== 0 && !value) {
        params[key] = '';
        sign += key + '=&';
      } else {
        sign += key + '=' + params[key] + '&';
      }
    }
  }
  sign += 'url=' + path + '&';
  sign += token ? 'accessToken=' + token + '&' : '';
  sign += 'timestamp=' + timestamp + '&';
  sign += 'nonceStr=' + nonceStr + '&';
  sign += 'key=' + config_1.Config.PLAM_KEY;
  return encrypt_and_decrypt_1.md5Encrypt(sign);
}
function getDataFromServer(path, method, enableCache, refresh, cacheKey, cacheTimeKey, params) {
  return new Promise(function(resolve, reject) {
    const app = getApp();
    let token = '';
    if (app.globalData.userInfo && app.globalData.userInfo.accessToken) {
      token = app.globalData.userInfo.accessToken;
    }
    const obj = {
      url: path,
      method: method,
      success: function(res) {
        res.data.message = res.data.message === 'No message available' ? '接口不存在，请检查！' : res.data.message;
        if (res.data.message === '签名错误') {
          wx_helper_1.hideLoading();
          wx.removeStorageSync(encrypt_and_decrypt_1.encryptByDESModeECB('user-info'));
          app.globalData.userInfo = {};
          alert({
            content: '您的账号在其他设备登录，如果这不是您的操作，您的登录验证码已经泄露，请重新登录！',
            showCancel: true,
            confirmText: '去登录',
            confirm: function() {},
            cancel: function() {}
          });
          reject();
        } else {
          if ((enableCache || refresh) && res.data.code === 0) {
            wx.setStorageSync(cacheKey, JSON.stringify(res.data));
            wx.setStorageSync(cacheTimeKey, Date.now());
          }
          res.data.backFromCache = false;
          resolve(res.data);
        }
      },
      fail: function(res) {
        console.log(res);
        reject();
      }
    };
    let header = {};
    let timestamp, nonceStr;
    nonceStr = util_1.uuid();
    timestamp = parseInt(((Date.now() + app.globalData.timeDifference) / 1000).toFixed(0), 10);
    if (method === 'POST') {
      header = {
        sign: _getSignature(params, obj.url.replace(config_1.Config.HOST, ''), token, timestamp, nonceStr),
        timestamp: timestamp,
        nonceStr: nonceStr
      };
      obj['data'] = params;
    } else {
      let url = obj.url + '?';
      for (let _i = 0, _a = Object.keys(params); _i < _a.length; _i++) {
        const key = _a[_i];
        url += key + '=' + params[key] + '&';
      }
      url = url.substring(0, url.length - 1);
      obj.url = url;
      header = {
        sign: _getSignature({}, obj.url.replace(config_1.Config.HOST, ''), token, timestamp, nonceStr),
        timestamp: timestamp,
        nonceStr: nonceStr
      };
    }
    if (token) {
      header.accessToken = token;
    }
    obj.header = header;
    wx.request(obj);
  });
}
exports.getDataFromServer = getDataFromServer;
function request(path, params, enableCache, refresh, method) {
  if (params === void 0) {
    params = {};
  }
  if (enableCache === void 0) {
    enableCache = false;
  }
  if (refresh === void 0) {
    refresh = false;
  }
  if (method === void 0) {
    method = 'POST';
  }
  path = _stitchingUrl(path);
  params['source'] = 'miniprogram';
  const cacheKey = encrypt_and_decrypt_1.encryptByDESModeECB(path + JSON.stringify(params));
  const cacheTimeKey = cacheKey + encrypt_and_decrypt_1.encryptByDESModeECB('time');
  if (enableCache && !refresh) {
    let cacheTime = wx.getStorageSync(cacheTimeKey);
    if (cacheTime && cacheKey !== 'undefined') {
      cacheTime = parseInt(cacheTime, 10);
      if (Date.now() - cacheTime < config_1.Config.CACHE_EXPIRE_TIME) {
        const data = wx.getStorageSync(cacheKey);
        if (data && data !== 'undefined') {
          console.log('==== 缓存查询数据返回 ====');
          const result = JSON.parse(data);
          result.backFromCache = true;
          return Promise.resolve(result);
        }
      } else {
        wx.removeStorageSync(cacheKey);
        wx.removeStorageSync(cacheTimeKey);
      }
    }
  }
  console.log('==== 网络查询数据返回 ====');
  return getDataFromServer(path, method, enableCache, refresh, cacheKey, cacheTimeKey, params);
}
exports.request = request;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImh0dHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBS0EsbUNBQWtDO0FBQ2xDLDZEQUF3RTtBQUV4RSx5Q0FBMEM7QUFDMUMsK0JBQThCO0FBRTlCLFNBQWdCLGFBQWEsQ0FBQyxHQUFXO0lBQ3ZDLE9BQU8sK0JBQStCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ25ELENBQUM7QUFGRCxzQ0FFQztBQU1ELFNBQVMsYUFBYSxDQUFDLEdBQVc7SUFDaEMsT0FBTyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsZUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztBQUNwRyxDQUFDO0FBV0QsU0FBUyxhQUFhLENBQUMsTUFBVyxFQUFFLElBQVksRUFBRSxLQUFhLEVBQUUsU0FBaUIsRUFBRSxRQUFnQjtJQUVsRyxJQUFNLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3hDLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUVkLEtBQWtCLFVBQUksRUFBSixhQUFJLEVBQUosa0JBQUksRUFBSixJQUFJLEVBQUU7UUFBbkIsSUFBTSxHQUFHLGFBQUE7UUFDWixJQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFMUIsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLElBQUksS0FBSyxLQUFLLElBQUksRUFBRTtZQUUvQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBRXBDLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxD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cGFyYW0gdXJsIOWIpOaWreeahOi3r+W+hFxuICovXG5cbmltcG9ydCB7IENvbmZpZyB9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCB7IGVuY3J5cHRCeURFU01vZGVFQ0IsIG1kNUVuY3J5cHQgfSBmcm9tICcuL2VuY3J5cHRfYW5kX2RlY3J5cHQnO1xuaW1wb3J0IHsgSVJlc3VsdCB9IGZyb20gJy4uLy4uL3R5cGluZ3MvdHlwZXMvcHJvamVjdC9odHRwX3JlcXVlc3QnO1xuaW1wb3J0IHsgaGlkZUxvYWRpbmcgfSBmcm9tICcuL3d4X2hlbHBlcic7XG5pbXBvcnQgeyB1dWlkIH0gZnJvbSAnLi91dGlsJztcblxuZXhwb3J0IGZ1bmN0aW9uIGlzQWJzb2x1dGVVcmwodXJsOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgcmV0dXJuIC8oXlthLXpdW2EtelxcZFxcK1xcLVxcLl0qOik/XFwvXFwvL2kudGVzdCh1cmwpO1xufVxuXG4vKipcbiAqIOaLvOaOpXVybFxuICogQHBhcmFtIHVybCDnm7jlr7not6/lvoTov5vooYzmi7zmjqXkuLrnvZHnu5zor7fmsYLot6/lvoRcbiAqL1xuZnVuY3Rpb24gX3N0aXRjaGluZ1VybCh1cmw6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBpc0Fic29sdXRlVXJsKHVybCkgPyB1cmwgOiBDb25maWcuSE9TVC5yZXBsYWNlKC9cXC8rJC8sICcnKSArICcvJyArIHVybC5yZXBsYWNlKC9eXFwvKy8sICcnKTtcbn1cblxuLyoqXG4gKiDnlJ/miJDliY3pnaJcbiAqIEBwYXJhbSBwYXJhbXMg5Y+C5pWwXG4gKiBAcGFyYW0gcGF0aCDor7fmsYLot6/lvoRcbiAqIEBwYXJhbSB0b2tlbiDnmbvlvZXlkI7nmoTku6TniYxcbiAqIEBwYXJhbSB0aW1lc3RhbXAg5pe26Ze05oizXG4gKiBAcGFyYW0gbm9uY2VTdHIgdXVpZFxuICogQHByaXZhdGVcbiAqL1xuZnVuY3Rpb24gX2dldFNpZ25hdHVyZShwYXJhbXM6IGFueSwgcGF0aDogc3RyaW5nLCB0b2tlbjogc3RyaW5nLCB0aW1lc3RhbXA6IG51bWJlciwgbm9uY2VTdHI6IHN0cmluZykge1xuICAvLyDlhYjku6Xlr7nosaFrZXnmjpLluo9cbiAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHBhcmFtcykuc29ydCgpO1xuICBsZXQgc2lnbiA9ICcnO1xuICAvLyDpobrluo/pgY3ljoZcbiAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgIGNvbnN0IHZhbHVlID0gcGFyYW1zW2tleV07XG4gICAgLy8gdmFsdWXmmK/kuKrlr7nosaFcbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZSAhPT0gbnVsbCkge1xuICAgICAgLy8g5a+5dmFsdWXkuLrlr7nosaHnmoTmlbDmja7ov5vooYzluo/liJfljJbmiJDlrZfnrKbkuLLvvIznhLblkI7mjInnhadhc2NpaeaOkuW6j1xuICAgICAgbGV0IHYgPSBKU09OLnN0cmluZ2lmeShwYXJhbXNba2V5XSk7XG4gICAgICAvLyDlr7l2YWx1Zei9rOS4uuWtl+espuS4sui/m+ihjOaOkuW6j+WkhOeQhlxuICAgICAgdiA9IHYuc3BsaXQoJycpLnNvcnQoKS5qb2luKCcnKTtcbiAgICAgIHNpZ24gKz0gYCR7a2V5fT0ke3Z9JmA7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOmdnuWvueixoVxuICAgICAgaWYgKHZhbHVlICE9PSAwICYmICF2YWx1ZSkge1xuICAgICAgICBwYXJhbXNba2V5XSA9ICcnO1xuICAgICAgICBzaWduICs9IGAke2tleX09JmA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzaWduICs9IGAke2tleX09JHtwYXJhbXNba2V5XX0mYDtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgLy8g5ou85o6ldXJsXG4gIHNpZ24gKz0gYHVybD0ke3BhdGh9JmA7XG5cbiAgLy8g5ou85o6ldG9rZW5cbiAgc2lnbiArPSB0b2tlbiA/IGBhY2Nlc3NUb2tlbj0ke3Rva2VufSZgIDogJyc7XG4gIHNpZ24gKz0gYHRpbWVzdGFtcD0ke3RpbWVzdGFtcH0mYDtcbiAgc2lnbiArPSBgbm9uY2VTdHI9JHtub25jZVN0cn0mYDtcbiAgLy8g5ou85o6la2V5XG4gIHNpZ24gKz0gJ2tleT0nICsgQ29uZmlnLlBMQU1fS0VZO1xuICByZXR1cm4gbWQ1RW5jcnlwdChzaWduKTtcbn1cblxuLyoqXG4gKiDku47nvZHnu5zojrflj5bmlbDmja5cbiAqIEBwYXJhbSBwYXRoIOi3r+W+hFxuICogQHBhcmFtIG1ldGhvZCDor7fmsYLmlrnms5VcbiAqIEBwYXJhbSBlbmFibGVDYWNoZSDmmK/lkKblupTnlKjnvJPlrZhcbiAqIEBwYXJhbSByZWZyZXNoIOaYr+WQpuW8uuWItuWIt+aWsOe8k+WtmFxuICogQHBhcmFtIGNhY2hlS2V5IOe8k+WtmGtleVxuICogQHBhcmFtIGNhY2hlVGltZUtleSDnvJPlrZjml7bpl7RrZXlcbiAqIEBwYXJhbSBwYXJhbXMg6K+35rGC5Y+C5pWwXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXREYXRhRnJvbVNlcnZlcjxUPihwYXRoOiBzdHJpbmcsIG1ldGhvZDogc3RyaW5nLCBlbmFibGVDYWNoZTogYm9vbGVhbiwgcmVmcmVzaDogYm9vbGVhbiwgY2FjaGVLZXk6IHN0cmluZywgY2FjaGVUaW1lS2V5OiBzdHJpbmcsIHBhcmFtczogYW55KTogUHJvbWlzZTxJUmVzdWx0PFQ+PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZTxJUmVzdWx0PFQ+PigocmVzb2x2ZTogYW55LCByZWplY3Q6IGFueSkgPT4ge1xuICAgIGNvbnN0IGFwcDogSUFwcE9wdGlvbiA9IGdldEFwcCgpO1xuICAgIC8vIOWwgeijheivt+axguWvueixoVxuICAgIGxldCB0b2tlbiA9ICcnO1xuICAgIGlmIChhcHAuZ2xvYmFsRGF0YS51c2VySW5mbyAmJiBhcHAuZ2xvYmFsRGF0YS51c2VySW5mby5hY2Nlc3NUb2tlbikge1xuICAgICAgdG9rZW4gPSBhcHAuZ2xvYmFsRGF0YS51c2VySW5mby5hY2Nlc3NUb2tlbjtcbiAgICB9XG4gICAgY29uc3Qgb2JqOiBhbnkgPSB7XG4gICAgICB1cmw6IHBhdGgsXG4gICAgICBtZXRob2Q6IG1ldGhvZCxcbiAgICAgIHN1Y2Nlc3M6IChyZXM6IHsgZGF0YTogSVJlc3VsdDxUPiB9KSA9PiB7XG4gICAgICAgIHJlcy5kYXRhLm1lc3NhZ2UgPSByZXMuZGF0YS5tZXNzYWdlID09PSAnTm8gbWVzc2FnZSBhdmFpbGFibGUnID8gJ+aOpeWPo+S4jeWtmOWcqO+8jOivt+ajgOafpe+8gScgOiByZXMuZGF0YS5tZXNzYWdlO1xuICAgICAgICBpZiAocmVzLmRhdGEubWVzc2FnZSA9PT0gJ+etvuWQjemUmeivrycpIHtcbiAgICAgICAgICBoaWRlTG9hZGluZygpO1xuICAgICAgICAgIHd4LnJlbW92ZVN0b3JhZ2VTeW5jKGVuY3J5cHRCeURFU01vZGVFQ0IoJ3VzZXItaW5mbycpKTtcbiAgICAgICAgICBhcHAuZ2xvYmFsRGF0YS51c2VySW5mbyA9IHt9O1xuICAgICAgICAgIGFsZXJ0KHtcbiAgICAgICAgICAgIGNvbnRlbnQ6ICfmgqjnmoTotKblj7flnKjlhbbku5borr7lpIfnmbvlvZXvvIzlpoLmnpzov5nkuI3mmK/mgqjnmoTmk43kvZzvvIzmgqjnmoTnmbvlvZXpqozor4HnoIHlt7Lnu4/ms4TpnLLvvIzor7fph43mlrDnmbvlvZXvvIEnLFxuICAgICAgICAgICAgc2hvd0NhbmNlbDogdHJ1ZSxcbiAgICAgICAgICAgIGNvbmZpcm1UZXh0OiAn5Y6755m75b2VJyxcbiAgICAgICAgICAgIGNvbmZpcm06ICgpID0+IHtcbiAgICAgICAgICAgICAgLy8gVE9ETyDljrvnmbvlvZVcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjYW5jZWw6ICgpID0+IHt9XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmVqZWN0KCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8g5q2j5bi46K+35rGC6L+U5ZueXG4gICAgICAgICAgLy8g5piv5ZCm5byA5ZCv57yT5a2Y5oiW6ICF5by65Yi25Yi35paw57yT5a2YXG4gICAgICAgICAgaWYgKChlbmFibGVDYWNoZSB8fCByZWZyZXNoKSAmJiByZXMuZGF0YS5jb2RlID09PSAwKSB7XG4gICAgICAgICAgICAvLyDov5vooYzmlbDmja7nvJPlrZhcbiAgICAgICAgICAgIHd4LnNldFN0b3JhZ2VTeW5jKGNhY2hlS2V5LCBKU09OLnN0cmluZ2lmeShyZXMuZGF0YSkpO1xuICAgICAgICAgICAgd3guc2V0U3RvcmFnZVN5bmMoY2FjaGVUaW1lS2V5LCBEYXRlLm5vdygpKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzLmRhdGEuYmFja0Zyb21DYWNoZSA9IGZhbHNlO1xuICAgICAgICAgIHJlc29sdmUocmVzLmRhdGEpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgZmFpbDogKHJlczogYW55KSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKHJlcyk7XG4gICAgICAgIHJlamVjdCgpO1xuICAgICAgfVxuICAgIH07XG4gICAgbGV0IGhlYWRlcjogYW55ID0ge307XG4gICAgLy8gdGltZXN0YW1wIOaXtumXtOaIsyAgbm9uY2VTdHLpmo/mnLrlrZfnrKbkuLIgdXVpZFxuICAgIGxldCB0aW1lc3RhbXAsIG5vbmNlU3RyO1xuICAgIG5vbmNlU3RyID0gdXVpZCgpO1xuICAgIHRpbWVzdGFtcCA9IHBhcnNlSW50KCgoRGF0ZS5ub3coKSArIGFwcC5nbG9iYWxEYXRhLnRpbWVEaWZmZXJlbmNlKSAvIDEwMDApLnRvRml4ZWQoMCksIDEwKTtcbiAgICAvLyBQT1NU6K+35rGCXG4gICAgaWYgKG1ldGhvZCA9PT0gJ1BPU1QnKSB7XG4gICAgICAvLyDorr7nva7nrb7lkI1cbiAgICAgIGhlYWRlciA9IHtcbiAgICAgICAgc2lnbjogX2dldFNpZ25hdHVyZShwYXJhbXMsIG9iai51cmwucmVwbGFjZShDb25maWcuSE9TVCwgJycpLCB0b2tlbiwgdGltZXN0YW1wLCBub25jZVN0ciksXG4gICAgICAgIHRpbWVzdGFtcDogdGltZXN0YW1wLFxuICAgICAgICBub25jZVN0cjogbm9uY2VTdHJcbiAgICAgIH07XG4gICAgICAvLyDorr7nva7or7fmsYLkvZNcbiAgICAgIG9ialsnZGF0YSddID0gcGFyYW1zO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBHRVTor7fmsYJcbiAgICAgIC8vIOaLvOaOpeivt+axgui3r+W+hFxuICAgICAgbGV0IHVybCA9IG9iai51cmwgKyAnPyc7XG4gICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhwYXJhbXMpKSB7XG4gICAgICAgIHVybCArPSBgJHtrZXl9PSR7cGFyYW1zW2tleV19JmA7XG4gICAgICB9XG4gICAgICB1cmwgPSB1cmwuc3Vic3RyaW5nKDAsIHVybC5sZW5ndGggLSAxKTtcbiAgICAgIG9iai51cmwgPSB1cmw7XG4gICAgICAvLyDorr7nva7nrb7lkI1cbiAgICAgIGhlYWRlciA9IHtcbiAgICAgICAgc2lnbjogX2dldFNpZ25hdHVyZSh7fSwgb2JqLnVybC5yZXBsYWNlKENvbmZpZy5IT1NULCAnJyksIHRva2VuLCB0aW1lc3RhbXAsIG5vbmNlU3RyKSxcbiAgICAgICAgdGltZXN0YW1wOiB0aW1lc3RhbXAsXG4gICAgICAgIG5vbmNlU3RyOiBub25jZVN0clxuICAgICAgfTtcbiAgICB9XG4gICAgLy8g6K6+572udG9rZW5cbiAgICBpZiAodG9rZW4pIHtcbiAgICAgIGhlYWRlci5hY2Nlc3NUb2tlbiA9IHRva2VuO1xuICAgIH1cbiAgICAvLyDorr7nva7or7fmsYLlpLRcbiAgICBvYmouaGVhZGVyID0gaGVhZGVyO1xuICAgIC8vIOaJp+ihjOivt+axglxuICAgIHd4LnJlcXVlc3Qob2JqKTtcbiAgfSk7XG59XG5cbi8qKlxuICog572R57uc6K+35rGCXG4gKiBAcGFyYW0gcGF0aCDor7fmsYLot6/lvoRcbiAqIEBwYXJhbSBwYXJhbXMg6K+35rGC5Y+C5pWwXG4gKiBAcGFyYW0gZW5hYmxlQ2FjaGUg5piv5ZCm5byA5ZCv57yT5a2YXG4gKiBAcGFyYW0gcmVmcmVzaCDmmK/lkKblvLrliLbliLfmlrDnvJPlrZhcbiAqIEBwYXJhbSBtZXRob2QgSHR0cOivt+axguaWueazlVxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVxdWVzdDxUPihwYXRoOiBzdHJpbmcsIHBhcmFtczogYW55ID0ge30sIGVuYWJsZUNhY2hlOiBib29sZWFuID0gZmFsc2UsIHJlZnJlc2g6IGJvb2xlYW4gPSBmYWxzZSwgbWV0aG9kOiBzdHJpbmcgPSAnUE9TVCcpOiBQcm9taXNlPElSZXN1bHQ8VD4+IHtcbiAgLy8g5aSE55CG6Lev5b6EXG4gIHBhdGggPSBfc3RpdGNoaW5nVXJsKHBhdGgpO1xuICBwYXJhbXNbJ3NvdXJjZSddID0gJ21pbmlwcm9ncmFtJztcbiAgLy8g5aSE55CG5Y+C5pWwXG4gIC8vIHBhcmFtcyA9IF9oYW5kbGVQYXJhbXMocGFyYW1zLCBwYXRoKTtcbiAgY29uc3QgY2FjaGVLZXkgPSBlbmNyeXB0QnlERVNNb2RlRUNCKHBhdGggKyBKU09OLnN0cmluZ2lmeShwYXJhbXMpKTtcbiAgLy8g57yT5a2Y5pe26Ze0XG4gIGNvbnN0IGNhY2hlVGltZUtleSA9IGNhY2hlS2V5ICsgZW5jcnlwdEJ5REVTTW9kZUVDQigndGltZScpO1xuICAvLyDlvIDlkK/kuobnvJPlrZjvvIzkvYbmmK/kuI3mmK/lvLrliLbliLfmlrDml7bor7vlj5bnvJPlrZhcbiAgaWYgKGVuYWJsZUNhY2hlICYmICFyZWZyZXNoKSB7XG4gICAgLy8g55Sf5oiQ57yT5a2Ya2V5XG4gICAgLy8g5p+l6K+i5piv5ZCm5bey5pyJ57yT5a2YXG4gICAgbGV0IGNhY2hlVGltZSA9IHd4LmdldFN0b3JhZ2VTeW5jKGNhY2hlVGltZUtleSk7XG4gICAgaWYgKGNhY2hlVGltZSAmJiBjYWNoZUtleSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIC8vIOaXtumXtOavq+enkuWAvFxuICAgICAgY2FjaGVUaW1lID0gcGFyc2VJbnQoY2FjaGVUaW1lLCAxMCk7XG4gICAgICBpZiAoRGF0ZS5ub3coKSAtIGNhY2hlVGltZSA8IENvbmZpZy5DQUNIRV9FWFBJUkVfVElNRSkge1xuICAgICAgICAvLyDmnKrov4fmnJ/vvIzor7vlj5bnvJPlrZjmlbDmja7ov5Tlm55cbiAgICAgICAgY29uc3QgZGF0YSA9IHd4LmdldFN0b3JhZ2VTeW5jKGNhY2hlS2V5KTtcbiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnPT09PSDnvJPlrZjmn6Xor6LmlbDmja7ov5Tlm54gPT09PScpO1xuICAgICAgICAgIGNvbnN0IHJlc3VsdDogSVJlc3VsdDxUPiA9IEpTT04ucGFyc2UoZGF0YSk7XG4gICAgICAgICAgcmVzdWx0LmJhY2tGcm9tQ2FjaGUgPSB0cnVlO1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8g56e76Zmk57yT5a2YXG4gICAgICAgIHd4LnJlbW92ZVN0b3JhZ2VTeW5jKGNhY2hlS2V5KTtcbiAgICAgICAgd3gucmVtb3ZlU3RvcmFnZVN5bmMoY2FjaGVUaW1lS2V5KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgY29uc29sZS5sb2coJz09PT0g572R57uc5p+l6K+i5pWw5o2u6L+U5ZueID09PT0nKTtcbiAgcmV0dXJuIGdldERhdGFGcm9tU2VydmVyKHBhdGgsIG1ldGhvZCwgZW5hYmxlQ2FjaGUsIHJlZnJlc2gsIGNhY2hlS2V5LCBjYWNoZVRpbWVLZXksIHBhcmFtcyk7XG59XG4iXX0=
